#!/usr/bin/env zsh
# xkcd-downloader
# Download comics from xkcd to the local archive
## Copyright (C) 2008 by Daniel Friesel <derf@derf.homelinux.org>
## License: WTFPL <http://sam.zoy.org/wtfpl>
SKEL='/home/dn42/html/comics/xkcd/skel'
TARGET='/home/dn42/html/comics/xkcd'
IMGDIR='/home/dn42/html/comics/xkcd/pics'
function download {
	NUMBER=$1
	IMGTAG=$(curl -s http://xkcd.com/$NUMBER/ | fgrep "imgs.xkcd.com/comics/" | head -n 1)
	NAME=$(sed -r "s/^.*alt\=\"([^\"]*)\".*$/\1/" <<< "$IMGTAG")
	DESC=$(sed -r "s/^.*title\=\"([^\"]*)\".*$/\1/" <<< "$IMGTAG")
	URL=$(sed -r "s/^.*src\=\"([^\"]*)\".*$/\1/" <<< "$IMGTAG")
	IMG="pics/$NUMBER.jpg"
	NEXT="$[$NUMBER+1].html"
	PREV="$[$NUMBER-1].html"
	echo
	echo Number "$NUMBER"
	echo Name "$NAME"
	echo Desc "$DESC"
	echo URL "$URL"
	cat "$SKEL" | \
	sed "s~@NAME@~$NAME~g" | \
	sed "s~@IMG@~$IMG~g" | \
	sed "s~@DESC@~$DESC~g" | \
	sed "s~@PREV@~$PREV~g" | \
	sed "s~@NEXT@~$NEXT~g" > $TARGET/$NUMBER.html
	curl "$URL" > $IMGDIR/$NUMBER.jpg
	chmod 644 $TARGET/$NUMBER.html
	chmod 644 $IMGDIR/$NUMBER.jpg
	sleep 3
}

for (( NUMBER=$1 ; $NUMBER <= $2 ; NUMBER++ )); do
	[[ -r $IMGDIR/$NUMBER.jpg ]] || download $NUMBER
done
